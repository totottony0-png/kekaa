<!DOCTYPE html>
<html lang="ar" dir="rtl"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>كشف الطلاب المسجلين</title> 
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet"> 
    <style> 
        /* تعريف المتغيرات لتسهيل التعديل على الألوان */ 
        :root { 
            --primary-color: #007bff; /* أزرق أساسي */ 
            --secondary-color: #17a2b8; /* أزرق سماوي للتعديل */ 
            --danger-color: #dc3545; /* أحمر للحذف */ 
            --success-color: #28a745; /* أخضر للحفظ */
            --background-color: #f4f7f6; 
            --card-background: #ffffff; 
            --text-color: #333; 
            --border-color: #ddd; 
            --fake-color: #ffcccc; /* لون أحمر فاتح لتمييز الطلاب الفيك */
            --duplicate-color: #ffebcd; /* لون برتقالي فاتح لتمييز الطلاب المكررين */
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: var(--card-background); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-weight: 800;
        }
        
        /* تنسيق الفلاتر */
        .filters { 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            flex-wrap: wrap; 
            padding: 15px;
            background-color: #f0f3f5; 
            border-radius: 8px;
        }
        .filters .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .filters label { 
            font-size: 1.1em; 
            font-weight: 700; 
            color: #495057;
        }
        /* تنسيق عناصر الإدخال والاختيار */
        .filters select, .filters input[type="search"] { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            font-family: 'Cairo', sans-serif; 
            font-size: 1em; 
            transition: border-color 0.3s;
        }
        .filters input[type="search"] { 
            width: 250px; 
        }
        .filters select:focus, .filters input[type="search"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* تنسيق عداد الطلاب والتحميل */
        #total-count {
            font-weight: 700; 
            font-size: 1.2em; 
            color: var(--primary-color);
            padding: 5px 0;
        }
        #loading {
            color: var(--secondary-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        /* تنسيق الجدول */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            table-layout: auto; 
        }
        th, td { 
            border: 1px solid var(--border-color); 
            padding: 12px; 
            font-size: 15px; 
            vertical-align: middle; 
            text-align: center;
            width: auto; 
        }
        th:nth-child(2), td:nth-child(2) { /* خانة الاسم */
            min-width: 200px;
        }
        th:nth-child(5), td:nth-child(5) { /* خانة التاريخ */
            min-width: 150px;
        }
        thead { 
            background-color: var(--primary-color); 
            color: #fff; 
            font-weight: 700; 
        }
        tbody tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }
        tbody tr:hover {
            background-color: #e6f7ff; 
        }

        /* تنسيق أزرار الإجراءات (مستعاد) */
        .action-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 20px; 
            padding: 5px; 
            transition: transform 0.2s, color 0.2s; 
            margin: 0 3px;
        }
        .delete-btn { 
            color: var(--danger-color); 
        }
        .edit-btn { 
            color: var(--secondary-color); 
        }
        .save-btn { 
            color: var(--success-color); 
        }
        .action-btn:hover { 
            transform: scale(1.2); 
        }
        .edit-date-input { 
            padding: 6px; 
            border: 1px solid var(--secondary-color); 
            border-radius: 4px; 
            font-family: 'Cairo', sans-serif; 
            font-size: 15px; 
            text-align: center; 
        }
        /* تمييز صفوف الطلاب الفيك */
        .fake-student-row {
            background-color: var(--fake-color) !important;
        }
        /* تمييز صفوف الطلاب المكررين */
        .duplicate-student-row {
            background-color: var(--duplicate-color) !important;
        }
</style>
</head> 
<body>

<div class="container">
    <h1>كشف الطلاب المسجلين</h1>
    <div class="filters">
        <div class="filter-group">
            <label for="searchInput">🔍 بحث:</label>
            <input type="search" id="searchInput" placeholder="ابحث بالاسم أو الرقم القومي...">
        </div>
        <div class="filter-group">
            <label for="cityFilter">المحافظة:</label>
            <select id="cityFilter"></select>
        </div>
        <div class="filter-group">
            <label for="statusFilter">الحالة:</label>
            <select id="statusFilter">
                <option value="الكل">الكل</option>
                <option value="Fake">طلاب غير حقيقيين (فيك)</option>
                <option value="Duplicate">طلاب مكررين</option>
            </select>
        </div>
    </div>

    <p id="total-count" style="font-weight: bold; font-size: 1.2em;"></p>
    <p id="loading">جاري تحميل البيانات...</p>
    
    <table id="studentsTable" style="display:none;">
        <thead>
            <tr>
                <th style="width: auto;">م</th>
                <th style="width: auto;">الاسم رباعي</th>
                <th style="width: auto;">الرقم القومي</th>
                <th style="width: auto;">رقم الهاتف</th>
                <th style="width: auto;">تاريخ التسجيل</th>
                <th style="width: auto;">المحافظة</th>
                <th style="width: auto;">الإجراءات</th>             </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script type="module">
    // تم تحديث الـ import ليشمل remove و update
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBYJA6Geof8vMubrSrNhL1yEoI4W-ofWhQ",
        authDomain: "academy-9b03c.firebaseapp.com",
        databaseURL: "https://academy-9b03c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "academy-9b03c",
        storageBucket: "academy-9b03c.firebasestorage.app",
        messagingSenderId: "929195836341",
        appId: "1:929195836341:web:ec8250202f73c0cf528ffc"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const allGovernorates = ["الكل", "المنيا", "سوهاج", "قنا", "أسيوط", "بني سويف", "الفيوم", "القاهرة", "أسوان", "الأقصر", "الغردقة"];
    let allStudentsData = [];
    let fakeKeys = new Set();
    let duplicateKeys = new Set();


    const loadingMessage = document.getElementById('loading');
    const studentsTable = document.getElementById('studentsTable');
    const tableBody = document.getElementById('tableBody');
    const totalCount = document.getElementById('total-count');
    const cityFilter = document.getElementById('cityFilter');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');


    // =================================================================
    // دوال المساعدة وتحليل البيانات
    // =================================================================

    function replaceArabicDigits(str) {
        if (!str) return '';
        const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        const latinDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        let output = str;
        for (let i = 0; i < 10; i++) {
            output = output.replace(new RegExp(arabicDigits[i], 'g'), latinDigits[i]);
        }
        return output;
    }

    // دالة تحويل التاريخ إلى تنسيق ISO لـ datetime-local (مستعاد)
    function convertArabicDateToISO(arabicDate) {
        if (!arabicDate) return '';
        
        let standardDateStr = replaceArabicDigits(arabicDate).replace(/‏/g, '').replace(/،/g, '');
        let parts = standardDateStr.split(/\s+|،/).filter(Boolean);
        if (parts.length < 3) return ''; 

        let datePart = parts[0];
        let timePart = parts[1];
        let ampmPart = parts[2];
        
        let [day, month, year] = datePart.split('/').map(Number);
        if (!day || !month || !year) return '';

        let timeComponents = timePart.split(':').map(Number);
        let hour = timeComponents[0] || 0;
        let minute = timeComponents[1] || 0;
        
        if (ampmPart && ampmPart.includes('م') && hour < 12) {
            hour += 12;
        }
        if (ampmPart && ampmPart.includes('ص') && hour === 12) { 
            hour = 0;
        }

        const pad = (num) => String(num).padStart(2, '0');
        // هنا يتم إنشاء التاريخ ككائن Date ثم تحويله إلى سلسلة ISO دون ثواني ومنطقة زمنية لتجنب المشاكل في حقل الإدخال
        // نحتاج إلى العودة إلى تاريخ يتوافق مع حقل datetime-local
        return `${year}-${pad(month)}-${pad(day)}T${pad(hour)}:${pad(minute)}`;
    }

    // دالة تحويل تنسيق ISO إلى تنسيق عربي للحفظ (مستعاد)
    function convertISODateToArabic(isoDate) {
        if (!isoDate) return '';

        const date = new Date(isoDate);

        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const seconds = 0; 
        
        const ampm = hours >= 12 ? ' م' : ' ص';
        hours = hours % 12;
        hours = hours ? hours : 12; 

        const pad = (num) => String(num).padStart(2, '0');

        const finalDate = `${pad(day)}‏/${pad(month)}‏/${year} ${hours}:${pad(minutes)}:${pad(seconds)}${ampm}`;
        
        const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        const latinDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        let output = finalDate;
        for (let i = 0; i < 10; i++) {
            output = output.replace(new RegExp(latinDigits[i], 'g'), arabicDigits[i]);
        }
        
        return output;
    }

    // دالة تحويل التاريخ إلى كائن Date (معدلة للاستخدام الداخلي للفرز)
    function convertDateForSorting(arabicDate) {
        if (!arabicDate) return new Date(0);
        let standardDateStr = replaceArabicDigits(arabicDate).replace(/‏/g, '').replace(/،/g, '');
        let parts = standardDateStr.split(/\s+|،/).filter(Boolean);
        if (parts.length < 3) return new Date(0); 
        let datePart = parts[0];
        let timePart = parts[1];
        let ampmPart = parts[2];
        let [day, month, year] = datePart.split('/').map(Number);
        if (!day || !month || !year) return new Date(0);
        let timeComponents = timePart.split(':').map(Number);
        let hour = timeComponents[0] || 0;
        let minute = timeComponents[1] || 0;
        if (ampmPart && ampmPart.includes('م') && hour < 12) { hour += 12; }
        if (ampmPart && ampmPart.includes('ص') && hour === 12) { hour = 0; }
        return new Date(year, month - 1, day, hour, minute); 
    }


    function isFakeName(name) {
        if (!name) return true;
        const nameStr = name.trim();
        if (nameStr.length < 6) return true;
        const illegalChars = /[\d!@#$%^&*()_+=\[\]{};':"\\|,.<>/?~`]/;
        if (illegalChars.test(nameStr)) return true;
        if (/(.)\1{3,}/.test(nameStr)) return true;
        return false;
    }

    function isStudentFake(student) {
        if (isFakeName(student.name)) return true;
        const nationalIdStr = String(student.nationalId || '').trim();
        const fakeNationalId = nationalIdStr.length >= 10 && !nationalIdStr.startsWith('30');
        if (fakeNationalId) return true;
        const phoneStr = String(student.phone || '').trim();
        const allowedPrefixes = ['010', '011', '012', '015'];
        const fakePhone = phoneStr.length >= 8 && !allowedPrefixes.some(prefix => phoneStr.startsWith(prefix));
        if (fakePhone) return true;
        return false;
    }

    /**
     * دالة لتحديد الطلاب المكررين وغير الحقيقيين لمرة واحدة
     */
    function analyzeStudents() {
        fakeKeys.clear();
        duplicateKeys.clear();
        
        const studentsByCity = allStudentsData.reduce((acc, student) => {
            const city = student.city || 'Unknown';
            if (!acc[city]) {
                acc[city] = [];
            }
            acc[city].push(student);
            return acc;
        }, {});

        // 1. Determine Fake students (Global check)
        allStudentsData.forEach(student => {
            if (isStudentFake(student)) {
                fakeKeys.add(student.key);
            }
        });
        
        // 2. Determine Duplicates (Local check within each city)
        for (const city in studentsByCity) {
            const cityStudents = studentsByCity[city];
            
            // Local maps for this city only
            const nameMap = new Map();
            const nationalIdMap = new Map();
            const phoneMap = new Map();

            cityStudents.forEach(student => {
                const studentKey = student.key;
                
                // 1. Name Check (Normalized)
                const name = String(student.name || '').trim().toLowerCase();
                if (name.length >= 12) { 
                    const list = nameMap.get(name) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    nameMap.set(name, list);
                }

                // 2. National ID Check
                const nationalId = String(student.nationalId || '').trim();
                if (nationalId.length === 14) { 
                    const list = nationalIdMap.get(nationalId) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    nationalIdMap.set(nationalId, list);
                }

                // 3. Phone Check
                const phone = String(student.phone || '').trim();
                if (phone.length >= 11) { 
                    const list = phoneMap.get(phone) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    phoneMap.set(phone, list);
                }
            });
        }
    }

    // =================================================================
    // دوال الإجراءات (مستعاد)
    // =================================================================

    async function updateStudentDate(studentKey, newDate) {
        try {
            const studentRef = ref(db, `students/${studentKey}`);
            await update(studentRef, { date: newDate });
            
            // تحديث البيانات في الذاكرة
            const studentIndex = allStudentsData.findIndex(s => s.key === studentKey);
            if (studentIndex > -1) {
                allStudentsData[studentIndex].date = newDate;
            }
            
            alert("تم تحديث التاريخ بنجاح.");
            renderTable(); // إعادة عرض الجدول
        } catch (error) {
            alert("حدث خطأ أثناء محاولة التحديث.");
            console.error("خطأ في التحديث:", error);
        }
    }
    
    async function deleteStudent(studentKey, studentName) {
        if (!confirm(`هل أنت متأكد من حذف الطالب: ${studentName}؟`)) return;
        try {
            await remove(ref(db, `students/${studentKey}`));
            allStudentsData = allStudentsData.filter(student => student.key !== studentKey);
            // إزالة المفاتيح من المجموعات
            fakeKeys.delete(studentKey);
            duplicateKeys.delete(studentKey);

            renderTable();
            alert(`تم حذف الطالب ${studentName} بنجاح.`);
        } catch (error) {
            alert("حدث خطأ أثناء محاولة الحذف.");
            console.error("خطأ في الحذف:", error);
        }
    }

    // =================================================================
    // دالة عرض الجدول
    // =================================================================
    
    function renderTable() {
        const selectedCity = cityFilter.value;
        const searchQuery = searchInput.value.toLowerCase().trim();
        const selectedStatus = statusFilter.value;

        tableBody.innerHTML = '';
        
        const studentsToDisplay = allStudentsData
            .filter(student => {
                // فلتر المحافظة
                const cityMatch = selectedCity === 'الكل' || student.city === selectedCity;
                
                // فلتر البحث
                const name = student.name ? student.name.toLowerCase() : '';
                const nationalId = String(student.nationalId || '');
                const searchMatch = name.includes(searchQuery) || nationalId.includes(searchQuery);

                // فلتر الحالة
                let statusMatch = true;
                const isFake = fakeKeys.has(student.key);
                const isDuplicate = duplicateKeys.has(student.key);

                if (selectedStatus === 'Fake') {
                    statusMatch = isFake;
                } else if (selectedStatus === 'Duplicate') {
                    statusMatch = isDuplicate;
                }
                
                return cityMatch && searchMatch && statusMatch;
            })
            .sort((a, b) => {
                // 1. فرز أبجدي بالاسم (الأولوية)
                const nameA = (a.name || '').trim();
                const nameB = (b.name || '').trim();
                const nameComparison = nameA.localeCompare(nameB, 'ar', { sensitivity: 'base' });
                if (nameComparison !== 0) {
                    return nameComparison;
                }

                // 2. فرز تنازلي بالتاريخ (في حالة تكرار الاسم)
                const dateA = convertDateForSorting(a.date);
                const dateB = convertDateForSorting(b.date);
                return dateB - dateA; // تنازلي
            });
        
        totalCount.textContent = `إجمالي عدد الطلاب المعروضين: ${studentsToDisplay.length}`;

        if (studentsToDisplay.length > 0) {
            studentsTable.style.display = 'table';
            studentsToDisplay.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // تحديد وتمييز الصفوف
                const isFake = fakeKeys.has(student.key);
                const isDuplicate = duplicateKeys.has(student.key);
                let rowClass = '';
                
                // إعطاء الأولوية للـ "فيك"
                if (isFake) {
                    rowClass = 'fake-student-row';
                } else if (isDuplicate) {
                    rowClass = 'duplicate-student-row';
                }

                row.innerHTML = `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${student.name || ''}</td>
                        <td>${student.nationalId || ''}</td>
                        <td>${student.phone || ''}</td>
                        <td data-key="${student.key}">
                            <span class="date-text">${student.date || ''}</span>
                        </td>
                        <td>${student.city || ''}</td>
                        <td data-student-key="${student.key}">
                            <button class="action-btn edit-btn" title="تعديل التاريخ">✏️</button>
                            <button class="action-btn delete-btn" title="حذف الطالب">🗑️</button>
                        </td>
                    </tr>
                `;
                tableBody.appendChild(row);
            });
        } else {
            studentsTable.style.display = 'none';
        }
    }

    // =================================================================
    // دالة التهيئة والتحميل
    // =================================================================

    async function initialize() {
        loadingMessage.style.display = 'block';
        studentsTable.style.display = 'none';
        cityFilter.innerHTML = allGovernorates.map(g => `<option value="${g}">${g}</option>`).join('');
        
        // تعيين الفلتر الافتراضي على "المنيا"
        cityFilter.value = 'المنيا'; 
        
        try {
            const snapshot = await get(ref(db, 'students'));
            if (snapshot.exists()) {
                const data = snapshot.val();
                allStudentsData = [];
                for (const key in data) { 
                    allStudentsData.push({ key, ...data[key] }); 
                }
                // تحليل البيانات لتحديد الفيك والمكررين بعد التحميل
                analyzeStudents();
            }
            renderTable();
        } catch (error) { 
            console.error("Error loading data:", error); 
            alert("فشل في تحميل البيانات من قاعدة البيانات.");
        }
        loadingMessage.style.display = 'none';
    }

    // =================================================================
    // معالجات الأحداث (مستعاد)
    // =================================================================
    
    cityFilter.addEventListener('change', renderTable);
    searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);

    tableBody.addEventListener('click', (event) => {
        const target = event.target;
        const row = target.closest('tr');
        if (!row) return;

        const dateCell = row.querySelector('td[data-key]');
        const actionCell = row.querySelector('td[data-student-key]');
        if (!dateCell || !actionCell) return;
        
        const studentKey = dateCell.dataset.key;
        const student = allStudentsData.find(s => s.key === studentKey);
        
        if (!student) return;

        if (target.classList.contains('delete-btn')) {
            deleteStudent(student.key, student.name);
        }
        else if (target.classList.contains('edit-btn')) {
            // وضع حقل الإدخال
            const isoDate = convertArabicDateToISO(student.date);
            dateCell.innerHTML = `<input type="datetime-local" class="edit-date-input" value="${isoDate}">`;
            
            // استبدال زر التعديل بزر الحفظ
            actionCell.innerHTML = `
                <button class="action-btn save-btn" title="حفظ التاريخ">💾</button>
                <button class="action-btn delete-btn" title="حذف الطالب">🗑️</button>
            `;
            // ملاحظة: يتم إعادة ربط معالج الحذف عند إعادة رسم خلية الإجراءات
        }
        else if (target.classList.contains('save-btn')) {
            const newDateInput = dateCell.querySelector('.edit-date-input');
            if (newDateInput) {
                const isoValue = newDateInput.value;
                // تحويل القيمة العائدة إلى التنسيق العربي قبل الحفظ
                const newArabicDate = convertISODateToArabic(isoValue);
                
                // تحديث قاعدة البيانات
                updateStudentDate(student.key, newArabicDate);

                // إعادة عرض زر التعديل مكانه (سيتم ذلك عبر renderTable)
                dateCell.innerHTML = `<span class="date-text">${newArabicDate}</span>`;
            }
        }
    });

    initialize();
</script>
</body> 
</html>