<!DOCTYPE html>
<html lang="ar" dir="rtl"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</title> 
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet"> 
    <style> 
        /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† */ 
        :root { 
            --primary-color: #007bff; /* Ø£Ø²Ø±Ù‚ Ø£Ø³Ø§Ø³ÙŠ */ 
            --secondary-color: #17a2b8; /* Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */ 
            --danger-color: #dc3545; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø­Ø°Ù */ 
            --success-color: #28a745; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø­ÙØ¸ */
            --background-color: #f4f7f6; 
            --card-background: #ffffff; 
            --text-color: #333; 
            --border-color: #ddd; 
            --fake-color: #ffcccc; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± ÙØ§ØªØ­ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ÙÙŠÙƒ */
            --duplicate-color: #ffebcd; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† */
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: var(--card-background); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-weight: 800;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± */
        .filters { 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            flex-wrap: wrap; 
            padding: 15px;
            background-color: #f0f3f5; 
            border-radius: 8px;
        }
        .filters .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .filters label { 
            font-size: 1.1em; 
            font-weight: 700; 
            color: #495057;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        .filters select, .filters input[type="search"] { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            font-family: 'Cairo', sans-serif; 
            font-size: 1em; 
            transition: border-color 0.3s;
        }
        .filters input[type="search"] { 
            width: 250px; 
        }
        .filters select:focus, .filters input[type="search"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ */
        #total-count {
            font-weight: 700; 
            font-size: 1.2em; 
            color: var(--primary-color);
            padding: 5px 0;
        }
        #loading {
            color: var(--secondary-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            table-layout: auto; 
        }
        th, td { 
            border: 1px solid var(--border-color); 
            padding: 12px; 
            font-size: 15px; 
            vertical-align: middle; 
            text-align: center;
            width: auto; 
        }
        th:nth-child(2), td:nth-child(2) { /* Ø®Ø§Ù†Ø© Ø§Ù„Ø§Ø³Ù… */
            min-width: 200px;
        }
        th:nth-child(5), td:nth-child(5) { /* Ø®Ø§Ù†Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® */
            min-width: 150px;
        }
        thead { 
            background-color: var(--primary-color); 
            color: #fff; 
            font-weight: 700; 
        }
        tbody tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }
        tbody tr:hover {
            background-color: #e6f7ff; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ù…Ø³ØªØ¹Ø§Ø¯) */
        .action-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 20px; 
            padding: 5px; 
            transition: transform 0.2s, color 0.2s; 
            margin: 0 3px;
        }
        .delete-btn { 
            color: var(--danger-color); 
        }
        .edit-btn { 
            color: var(--secondary-color); 
        }
        .save-btn { 
            color: var(--success-color); 
        }
        .action-btn:hover { 
            transform: scale(1.2); 
        }
        .edit-date-input { 
            padding: 6px; 
            border: 1px solid var(--secondary-color); 
            border-radius: 4px; 
            font-family: 'Cairo', sans-serif; 
            font-size: 15px; 
            text-align: center; 
        }
        /* ØªÙ…ÙŠÙŠØ² ØµÙÙˆÙ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ÙÙŠÙƒ */
        .fake-student-row {
            background-color: var(--fake-color) !important;
        }
        /* ØªÙ…ÙŠÙŠØ² ØµÙÙˆÙ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† */
        .duplicate-student-row {
            background-color: var(--duplicate-color) !important;
        }
</style>
</head> 
<body>

<div class="container">
Â  Â  <h1>ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h1>
Â  Â  <div class="filters">
Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  <label for="searchInput">ğŸ” Ø¨Ø­Ø«:</label>
Â  Â  Â  Â  Â  Â  <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ...">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  <label for="cityFilter">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
Â  Â  Â  Â  Â  Â  <select id="cityFilter"></select>
Â  Â  Â  Â  </div>
        <div class="filter-group">
            <label for="statusFilter">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            <select id="statusFilter">
                <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option>
                <option value="Fake">Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ† (ÙÙŠÙƒ)</option>
                <option value="Duplicate">Ø·Ù„Ø§Ø¨ Ù…ÙƒØ±Ø±ÙŠÙ†</option>
            </select>
        </div>
Â  Â  </div>

Â  Â  <p id="total-count" style="font-weight: bold; font-size: 1.2em;"></p>
Â  Â  <p id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
Â  Â  
Â  Â  <table id="studentsTable" style="display:none;">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">Ù…</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: auto;">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                <th style="width: auto;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="tableBody"></tbody>
Â  Â  </table>
</div>

<script type="module">
    // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ import Ù„ÙŠØ´Ù…Ù„ remove Ùˆ update
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyBYJA6Geof8vMubrSrNhL1yEoI4W-ofWhQ",
Â  Â  Â  Â  authDomain: "academy-9b03c.firebaseapp.com",
Â  Â  Â  Â  databaseURL: "https://academy-9b03c-default-rtdb.europe-west1.firebasedatabase.app",
Â  Â  Â  Â  projectId: "academy-9b03c",
Â  Â  Â  Â  storageBucket: "academy-9b03c.firebasestorage.app",
Â  Â  Â  Â  messagingSenderId: "929195836341",
Â  Â  Â  Â  appId: "1:929195836341:web:ec8250202f73c0cf528ffc"
Â  Â  };
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getDatabase(app);
Â  Â  
Â  Â  const allGovernorates = ["Ø§Ù„ÙƒÙ„", "Ø§Ù„Ù…Ù†ÙŠØ§", "Ø³ÙˆÙ‡Ø§Ø¬", "Ù‚Ù†Ø§", "Ø£Ø³ÙŠÙˆØ·", "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø§Ù„ÙÙŠÙˆÙ…", "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø£Ø³ÙˆØ§Ù†", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„ØºØ±Ø¯Ù‚Ø©"];
Â  Â  let allStudentsData = [];
    let fakeKeys = new Set();
    let duplicateKeys = new Set();


Â  Â  const loadingMessage = document.getElementById('loading');
Â  Â  const studentsTable = document.getElementById('studentsTable');
Â  Â  const tableBody = document.getElementById('tableBody');
Â  Â  const totalCount = document.getElementById('total-count');
Â  Â  const cityFilter = document.getElementById('cityFilter');
Â  Â  const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');


    // =================================================================
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // =================================================================

    function replaceArabicDigits(str) {
Â  Â  Â  Â  if (!str) return '';
Â  Â  Â  Â  const arabicDigits = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
Â  Â  Â  Â  const latinDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
Â  Â  Â  Â  let output = str;
Â  Â  Â  Â  for (let i = 0; i < 10; i++) {
Â  Â  Â  Â  Â  Â  output = output.replace(new RegExp(arabicDigits[i], 'g'), latinDigits[i]);
Â  Â  Â  Â  }
Â  Â  Â  Â  return output;
Â  Â  }

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ ISO Ù„Ù€ datetime-local (Ù…Ø³ØªØ¹Ø§Ø¯)
    function convertArabicDateToISO(arabicDate) {
        if (!arabicDate) return '';
        
        let standardDateStr = replaceArabicDigits(arabicDate).replace(/â€/g, '').replace(/ØŒ/g, '');
        let parts = standardDateStr.split(/\s+|ØŒ/).filter(Boolean);
        if (parts.length < 3) return ''; 

        let datePart = parts[0];
        let timePart = parts[1];
        let ampmPart = parts[2];
        
        let [day, month, year] = datePart.split('/').map(Number);
        if (!day || !month || !year) return '';

        let timeComponents = timePart.split(':').map(Number);
        let hour = timeComponents[0] || 0;
        let minute = timeComponents[1] || 0;
        
        if (ampmPart && ampmPart.includes('Ù…') && hour < 12) {
            hour += 12;
        }
        if (ampmPart && ampmPart.includes('Øµ') && hour === 12) { 
            hour = 0;
        }

        const pad = (num) => String(num).padStart(2, '0');
        // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙƒØ§Ø¦Ù† Date Ø«Ù… ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© ISO Ø¯ÙˆÙ† Ø«ÙˆØ§Ù†ÙŠ ÙˆÙ…Ù†Ø·Ù‚Ø© Ø²Ù…Ù†ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        // Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø­Ù‚Ù„ datetime-local
        return `${year}-${pad(month)}-${pad(day)}T${pad(hour)}:${pad(minute)}`;
    }

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ ISO Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø­ÙØ¸ (Ù…Ø³ØªØ¹Ø§Ø¯)
    function convertISODateToArabic(isoDate) {
        if (!isoDate) return '';

        const date = new Date(isoDate);

        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const seconds = 0; 
        
        const ampm = hours >= 12 ? ' Ù…' : ' Øµ';
        hours = hours % 12;
        hours = hours ? hours : 12; 

        const pad = (num) => String(num).padStart(2, '0');

        const finalDate = `${pad(day)}â€/${pad(month)}â€/${year} ${hours}:${pad(minutes)}:${pad(seconds)}${ampm}`;
        
        const arabicDigits = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        const latinDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        let output = finalDate;
        for (let i = 0; i < 10; i++) {
            output = output.replace(new RegExp(latinDigits[i], 'g'), arabicDigits[i]);
        }
        
        return output;
    }

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Date (Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙØ±Ø²)
    function convertDateForSorting(arabicDate) {
Â  Â  Â  Â  if (!arabicDate) return new Date(0);
Â  Â  Â  Â  let standardDateStr = replaceArabicDigits(arabicDate).replace(/â€/g, '').replace(/ØŒ/g, '');
Â  Â  Â  Â  let parts = standardDateStr.split(/\s+|ØŒ/).filter(Boolean);
Â  Â  Â  Â  if (parts.length < 3) return new Date(0); 
Â  Â  Â  Â  let datePart = parts[0];
Â  Â  Â  Â  let timePart = parts[1];
Â  Â  Â  Â  let ampmPart = parts[2];
Â  Â  Â  Â  let [day, month, year] = datePart.split('/').map(Number);
Â  Â  Â  Â  if (!day || !month || !year) return new Date(0);
Â  Â  Â  Â  let timeComponents = timePart.split(':').map(Number);
Â  Â  Â  Â  let hour = timeComponents[0] || 0;
Â  Â  Â  Â  let minute = timeComponents[1] || 0;
Â  Â  Â  Â  if (ampmPart && ampmPart.includes('Ù…') && hour < 12) { hour += 12; }
Â  Â  Â  Â  if (ampmPart && ampmPart.includes('Øµ') && hour === 12) { hour = 0; }
Â  Â  Â  Â  return new Date(year, month - 1, day, hour, minute); 
Â  Â  }


    function isFakeName(name) {
        if (!name) return true;
        const nameStr = name.trim();
        if (nameStr.length < 6) return true;
        const illegalChars = /[\d!@#$%^&*()_+=\[\]{};':"\\|,.<>/?~`]/;
        if (illegalChars.test(nameStr)) return true;
        if (/(.)\1{3,}/.test(nameStr)) return true;
        return false;
    }

    function isStudentFake(student) {
        if (isFakeName(student.name)) return true;
        const nationalIdStr = String(student.nationalId || '').trim();
        const fakeNationalId = nationalIdStr.length >= 10 && !nationalIdStr.startsWith('30');
        if (fakeNationalId) return true;
        const phoneStr = String(student.phone || '').trim();
        const allowedPrefixes = ['010', '011', '012', '015'];
        const fakePhone = phoneStr.length >= 8 && !allowedPrefixes.some(prefix => phoneStr.startsWith(prefix));
        if (fakePhone) return true;
        return false;
    }

    /**
     * Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† ÙˆØºÙŠØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ† Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
     */
    function analyzeStudents() {
        fakeKeys.clear();
        duplicateKeys.clear();
        
        const studentsByCity = allStudentsData.reduce((acc, student) => {
            const city = student.city || 'Unknown';
            if (!acc[city]) {
                acc[city] = [];
            }
            acc[city].push(student);
            return acc;
        }, {});

        // 1. Determine Fake students (Global check)
        allStudentsData.forEach(student => {
            if (isStudentFake(student)) {
                fakeKeys.add(student.key);
            }
        });
        
        // 2. Determine Duplicates (Local check within each city)
        for (const city in studentsByCity) {
            const cityStudents = studentsByCity[city];
            
            // Local maps for this city only
            const nameMap = new Map();
            const nationalIdMap = new Map();
            const phoneMap = new Map();

            cityStudents.forEach(student => {
                const studentKey = student.key;
                
                // 1. Name Check (Normalized)
                const name = String(student.name || '').trim().toLowerCase();
                if (name.length >= 12) { 
                    const list = nameMap.get(name) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    nameMap.set(name, list);
                }

                // 2. National ID Check
                const nationalId = String(student.nationalId || '').trim();
                if (nationalId.length === 14) { 
                    const list = nationalIdMap.get(nationalId) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    nationalIdMap.set(nationalId, list);
                }

                // 3. Phone Check
                const phone = String(student.phone || '').trim();
                if (phone.length >= 11) { 
                    const list = phoneMap.get(phone) || [];
                    if (list.length > 0) {
                        list.forEach(key => duplicateKeys.add(key)); 
                        duplicateKeys.add(studentKey); 
                    }
                    list.push(studentKey);
                    phoneMap.set(phone, list);
                }
            });
        }
    }

    // =================================================================
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ù…Ø³ØªØ¹Ø§Ø¯)
    // =================================================================

    async function updateStudentDate(studentKey, newDate) {
        try {
            const studentRef = ref(db, `students/${studentKey}`);
            await update(studentRef, { date: newDate });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            const studentIndex = allStudentsData.findIndex(s => s.key === studentKey);
            if (studentIndex > -1) {
                allStudentsData[studentIndex].date = newDate;
            }
            
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­.");
            renderTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        } catch (error) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", error);
        }
    }
    
    async function deleteStudent(studentKey, studentName) {
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}ØŸ`)) return;
        try {
            await remove(ref(db, `students/${studentKey}`));
            allStudentsData = allStudentsData.filter(student => student.key !== studentKey);
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            fakeKeys.delete(studentKey);
            duplicateKeys.delete(studentKey);

            renderTable();
            alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentName} Ø¨Ù†Ø¬Ø§Ø­.`);
        } catch (error) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù.");
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
        }
    }

    // =================================================================
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    // =================================================================
    
Â  Â  function renderTable() {
Â  Â  Â  Â  const selectedCity = cityFilter.value;
Â  Â  Â  Â  const searchQuery = searchInput.value.toLowerCase().trim();
        const selectedStatus = statusFilter.value;

Â  Â  Â  Â  tableBody.innerHTML = '';
Â  Â  Â  Â  
Â  Â  Â  Â  const studentsToDisplay = allStudentsData
Â  Â  Â  Â  Â  Â  .filter(student => {
Â  Â  Â  Â  Â  Â  Â  Â  // ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
Â  Â  Â  Â  Â  Â  Â  Â  const cityMatch = selectedCity === 'Ø§Ù„ÙƒÙ„' || student.city === selectedCity;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
Â  Â  Â  Â  Â  Â  Â  Â  const name = student.name ? student.name.toLowerCase() : '';
Â  Â  Â  Â  Â  Â  Â  Â  const nationalId = String(student.nationalId || '');
Â  Â  Â  Â  Â  Â  Â  Â  const searchMatch = name.includes(searchQuery) || nationalId.includes(searchQuery);

                // ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
                let statusMatch = true;
                const isFake = fakeKeys.has(student.key);
                const isDuplicate = duplicateKeys.has(student.key);

                if (selectedStatus === 'Fake') {
                    statusMatch = isFake;
                } else if (selectedStatus === 'Duplicate') {
                    statusMatch = isDuplicate;
                }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  return cityMatch && searchMatch && statusMatch;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. ÙØ±Ø² Ø£Ø¨Ø¬Ø¯ÙŠ Ø¨Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)
                const nameA = (a.name || '').trim();
                const nameB = (b.name || '').trim();
                const nameComparison = nameA.localeCompare(nameB, 'ar', { sensitivity: 'base' });
                if (nameComparison !== 0) {
                    return nameComparison;
                }

                // 2. ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙÙŠ Ø­Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…)
Â  Â  Â  Â  Â  Â  Â  Â  const dateA = convertDateForSorting(a.date);
Â  Â  Â  Â  Â  Â  Â  Â  const dateB = convertDateForSorting(b.date);
Â  Â  Â  Â  Â  Â  Â  Â  return dateB - dateA; // ØªÙ†Ø§Ø²Ù„ÙŠ
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  totalCount.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: ${studentsToDisplay.length}`;

Â  Â  Â  Â  if (studentsToDisplay.length > 0) {
Â  Â  Â  Â  Â  Â  studentsTable.style.display = 'table';
Â  Â  Â  Â  Â  Â  studentsToDisplay.forEach((student, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
                
                // ØªØ­Ø¯ÙŠØ¯ ÙˆØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙÙˆÙ
                const isFake = fakeKeys.has(student.key);
                const isDuplicate = duplicateKeys.has(student.key);
                let rowClass = '';
                
                // Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù€ "ÙÙŠÙƒ"
                if (isFake) {
                    rowClass = 'fake-student-row';
                } else if (isDuplicate) {
                    rowClass = 'duplicate-student-row';
                }

Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${student.name || ''}</td>
                        <td>${student.nationalId || ''}</td>
                        <td>${student.phone || ''}</td>
                        <td data-key="${student.key}">
                            <span class="date-text">${student.date || ''}</span>
                        </td>
                        <td>${student.city || ''}</td>
                        <td data-student-key="${student.key}">
                            <button class="action-btn edit-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®">âœï¸</button>
                            <button class="action-btn delete-btn" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  tableBody.appendChild(row);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  studentsTable.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

    // =================================================================
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    // =================================================================

Â  Â  async function initialize() {
Â  Â  Â  Â  loadingMessage.style.display = 'block';
Â  Â  Â  Â  studentsTable.style.display = 'none';
Â  Â  Â  Â  cityFilter.innerHTML = allGovernorates.map(g => `<option value="${g}">${g}</option>`).join('');
Â  Â  Â  Â  
Â  Â  Â  Â  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù„Ù‰ "Ø§Ù„Ù…Ù†ÙŠØ§"
Â  Â  Â  Â  cityFilter.value = 'Ø§Ù„Ù…Ù†ÙŠØ§'; 
Â  Â  Â  Â  
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const snapshot = await get(ref(db, 'students'));
Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  allStudentsData = [];
Â  Â  Â  Â  Â  Â  Â  Â  for (const key in data) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allStudentsData.push({ key, ...data[key] }); 
Â  Â  Â  Â  Â  Â  Â  Â  }
                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙÙŠÙƒ ÙˆØ§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                analyzeStudents();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderTable();
Â  Â  Â  Â  } catch (error) { 
Â  Â  Â  Â  Â  Â  console.error("Error loading data:", error); 
Â  Â  Â  Â  Â  Â  alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
Â  Â  Â  Â  }
Â  Â  Â  Â  loadingMessage.style.display = 'none';
Â  Â  }

Â  Â  // =================================================================
    // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù…Ø³ØªØ¹Ø§Ø¯)
    // =================================================================
    
Â  Â  cityFilter.addEventListener('change', renderTable);
Â  Â  searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);

    tableBody.addEventListener('click', (event) => {
        const target = event.target;
        const row = target.closest('tr');
        if (!row) return;

        const dateCell = row.querySelector('td[data-key]');
        const actionCell = row.querySelector('td[data-student-key]');
        if (!dateCell || !actionCell) return;
        
        const studentKey = dateCell.dataset.key;
        const student = allStudentsData.find(s => s.key === studentKey);
        
        if (!student) return;

        if (target.classList.contains('delete-btn')) {
            deleteStudent(student.key, student.name);
        }
        else if (target.classList.contains('edit-btn')) {
            // ÙˆØ¶Ø¹ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            const isoDate = convertArabicDateToISO(student.date);
            dateCell.innerHTML = `<input type="datetime-local" class="edit-date-input" value="${isoDate}">`;
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø²Ø± Ø§Ù„Ø­ÙØ¸
            actionCell.innerHTML = `
                <button class="action-btn save-btn" title="Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ®">ğŸ’¾</button>
                <button class="action-btn delete-btn" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨">ğŸ—‘ï¸</button>
            `;
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø®Ù„ÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        }
        else if (target.classList.contains('save-btn')) {
            const newDateInput = dateCell.querySelector('.edit-date-input');
            if (newDateInput) {
                const isoValue = newDateInput.value;
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø§Ø¦Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                const newArabicDate = convertISODateToArabic(isoValue);
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                updateStudentDate(student.key, newArabicDate);

                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙƒØ§Ù†Ù‡ (Ø³ÙŠØªÙ… Ø°Ù„Ùƒ Ø¹Ø¨Ø± renderTable)
                dateCell.innerHTML = `<span class="date-text">${newArabicDate}</span>`;
            }
        }
    });

Â  Â  initialize();
</script>
</body> 
</html>